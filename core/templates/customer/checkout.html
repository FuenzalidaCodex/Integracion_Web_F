{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}
{% block content %}
<h1>Checkout</h1>
{% if cart.items.all %}
<form id="payment-form">
    <div class="mb-3">
        <label for="delivery_method" class="form-label">Método de Entrega</label>
        <select name="delivery_method" id="delivery_method" class="form-control">
            <option value="store">Retiro en Tienda</option>
            <option value="home">Despacho a Domicilio</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="shipping_address" class="form-label">Dirección de Envío</label>
        <select name="shipping_address" id="shipping_address" class="form-control">
            {% for address in user.addresses.all %}
            <option value="{{ address.id }}">{{ address.street_address }}, {{ address.country }}</option>
            {% empty %}
            <option value="">No hay direcciones registradas</option>
            {% endfor %}
        </select>
    </div>
    <div id="card-element" class="form-control"></div>
    <div id="card-errors" role="alert" class="text-danger"></div>
    <button id="submit" class="btn btn-primary mt-3">Pagar ${{ cart.get_total }}</button>
</form>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ publishable_key }}');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    card.addEventListener('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const deliveryMethod = document.getElementById('delivery_method').value;
        const shippingAddressId = document.getElementById('shipping_address').value;

        // Crear orden
        const orderResponse = await fetch('/api/orders/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer {{ request.session.access_token }}' // Ajustar según autenticación
            },
            body: JSON.stringify({
                user_id: {{ user.id }},
                delivery_method: deliveryMethod,
                shipping_address_id: shippingAddressId,
                items: [
                    {% for item in cart.items.all %}
                    { product_id: {{ item.product.id }}, quantity: {{ item.quantity }}, price: {{ item.price }} },
                    {% endfor %}
                ]
            })
        });
        const orderData = await orderResponse.json();

        // Crear intento de pago
        const response = await fetch('/api/create-payment-intent/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                order_id: orderData.id,
                amount: {{ cart.get_total }}
            })
        });
        const { clientSecret } = await response.json();

        const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: { card: card }
        });

        if (result.error) {
            document.getElementById('card-errors').textContent = result.error.message;
        } else {
            if (result.paymentIntent.status === 'succeeded') {
                window.location.href = '/'; // Redirige tras pago exitoso
            }
        }
    });
</script>
{% else %}
<p>Tu carrito está vacío.</p>
<a href="{% url 'customer_catalog' %}" class="btn btn-primary">Volver al Catálogo</a>
{% endif %}
{% endblock %}