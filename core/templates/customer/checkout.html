{% extends 'base.html' %}
{% block title %}Checkout{% endblock %}
{% block content %}
{% if user.is_authenticated %}
<h1>Checkout</h1>
{% if messages %}
<div class="alert-container">
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endfor %}
</div>
{% endif %}
{% if cart.items.all %}
<div class="card">
  <div class="card-body">
    <form id="payment-form" method="post">
      {% csrf_token %}
      <div class="mb-3">
        <label for="delivery_method" class="form-label">Método de Entrega</label>
        <select name="delivery_method" id="delivery_method" class="form-control" required>
          <option value="" disabled selected>Selecciona un método</option>
          <option value="store">Retiro en Tienda</option>
          <option value="home">Despacho a Domicilio</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="shipping_address" class="form-label">Dirección de Envío</label>
        <select name="shipping_address" id="shipping_address" class="form-control" required>
          <option value="" disabled selected>Selecciona una dirección</option>
          {% for address in user.addresses.all %}
          <option value="{{ address.id }}">{{ address.street_address }}, {{ address.country }}</option>
          {% empty %}
          <option value="" disabled>No hay direcciones registradas</option>
          {% endfor %}
        </select>
        <a href="{% url 'customer_add_address' %}" class="btn btn-link mt-2">Añadir Nueva Dirección</a>
      </div>
      <div class="mb-3">
        <label for="card-element" class="form-label">Información de Pago</label>
        <div id="card-element" class="form-control"></div>
        <div id="card-errors" role="alert" class="text-danger mt-2"></div>
      </div>
      <button id="submit" class="btn btn-primary mt-3" disabled>Pagar ${{ cart.get_total|floatformat:2 }}</button>
    </form>
  </div>
  <div class="card-footer">
    <a href="{% url 'customer_cart' %}" class="btn btn-secondary">Volver al Carrito</a>
  </div>
</div>
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Helper to get CSRF token from cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const stripe = Stripe('{{ publishable_key }}');
  const elements = stripe.elements();
  const card = elements.create('card');
  card.mount('#card-element');

  card.addEventListener('change', function (event) {
    const displayError = document.getElementById('card-errors');
    if (event.error) {
      displayError.textContent = event.error.message;
    } else {
      displayError.textContent = '';
    }
  });

  const form = document.getElementById('payment-form');
  const submitButton = document.getElementById('submit');
  const deliveryMethod = document.getElementById('delivery_method');
  const shippingAddress = document.getElementById('shipping_address');

  function updateSubmitState() {
    submitButton.disabled = !(deliveryMethod.value && shippingAddress.value);
  }
  form.addEventListener('change', updateSubmitState);
  document.addEventListener('DOMContentLoaded', updateSubmitState);

  // Cart items passed as JSON from backend for safe JS usage
  const cartItems = JSON.parse(document.getElementById('cart-items-data').textContent);

  form.addEventListener('submit', async function (event) {
    event.preventDefault();
    submitButton.disabled = true;
    submitButton.textContent = 'Procesando...';

    try {
      const orderResponse = await fetch('/api/orders/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          delivery_method: deliveryMethod.value,
          shipping_address_id: shippingAddress.value,
          items: cartItems
        })
      });

      if (!orderResponse.ok) {
        throw new Error('Error al crear la orden');
      }

      const orderData = await orderResponse.json();

      const paymentResponse = await fetch('/api/create-payment-intent/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          order_id: orderData.id,
          amount: {{ cart_total_cents }}
              })
            });

  if (!paymentResponse.ok) {
    throw new Error('Error al crear el intento de pago');
  }

  const { clientSecret } = await paymentResponse.json();

  const result = await stripe.confirmCardPayment(clientSecret, {
    payment_method: { card: card }
  });

  if (result.error) {
    document.getElementById('card-errors').textContent = result.error.message;
    submitButton.disabled = false;
    submitButton.textContent = 'Pagar ${{ cart.get_total|floatformat:2 }}';
  } else if (result.paymentIntent.status === 'succeeded') {
    window.location.href = '/';
  }
          } catch (error) {
    document.getElementById('card-errors').textContent = error.message;
    submitButton.disabled = false;
    submitButton.textContent = 'Pagar ${{ cart.get_total|floatformat:2 }}';
  }
        });
</script>
<script id="cart-items-data" type="application/json">{{ cart_items_json|safe }}</script>
{% else %}
<p class="text-muted">Tu carrito está vacío.</p>
<a href="{% url 'customer_catalog' %}" class="btn btn-primary">Volver al Catálogo</a>
<a href="{% url 'index' %}" class="btn btn-secondary ms-2">Volver al Inicio</a>
{% endif %}
{% else %}
<p class="text-muted">Debes iniciar sesión para proceder al checkout.</p>
<a href="{% url 'login' %}?next={% url 'customer_checkout' %}" class="btn btn-primary">Iniciar Sesión</a>
<a href="{% url 'index' %}" class="btn btn-secondary ms-2">Volver al Inicio</a>
{% endif %}
{% endblock %}